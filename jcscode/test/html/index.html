<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JCS Code Auth • Fluxo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-dark text-light">
  <div class="container py-4">
    <h3 class="mb-3">Fluxo de Autenticação <span class="badge bg-secondary">/v1</span></h3>

    <div id="cadastro" class="card bg-secondary-subtle text-dark mb-3" style="max-width:540px">
      <div class="card-body">
        <h5 class="card-title">Cadastro</h5>
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input id="email" class="form-control" placeholder="email" />
        </div>
        <div class="mb-3">
          <label class="form-label">Senha</label>
          <input id="password" class="form-control" type="password" placeholder="senha" />
        </div>
        <button class="btn btn-primary" onclick="signup()">Cadastrar</button>
      </div>
    </div>

    <div id="verificar" class="card bg-secondary-subtle text-dark mb-3" style="max-width:540px; display:none">
      <div class="card-body">
        <h5 class="card-title">Verificar Código</h5>
        <div class="mb-2">
          <label class="form-label">Email</label>
          <input id="email_verify" class="form-control" placeholder="email" />
        </div>
        <div class="mb-3">
          <label class="form-label">Código</label>
          <input id="code" class="form-control" placeholder="código 6 dígitos" />
        </div>
        <button class="btn btn-success" onclick="verifyEmail()">Validar</button>
        <button class="btn btn-outline-secondary ms-2" onclick="resendVerify()">Reenviar Código</button>
      </div>
    </div>

    <div id="usuarios" class="card bg-secondary-subtle text-dark" style="display:none">
      <div class="card-body">
        <h5 class="card-title">Usuários</h5>
        <div class="d-flex gap-2 mb-2">
          <input id="new_email" class="form-control" placeholder="novo email" style="max-width:280px" />
          <input id="new_name" class="form-control" placeholder="nome" style="max-width:180px" />
          <button class="btn btn-primary" onclick="createUser()">Incluir</button>
          <button class="btn btn-outline-primary" onclick="loadUsers()">Atualizar</button>
        </div>
        <div class="table-responsive">
          <table class="table table-dark table-striped" id="usersTable">
            <thead><tr><th>Email</th><th>Nome</th><th>Status</th><th>Ações</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <pre id="out" class="mt-3 p-3 bg-dark border border-secondary rounded" style="max-height:320px; overflow:auto"></pre>
  </div>

  <script>
    const BASE = '/v1';
    const g = id => document.getElementById(id);
    const out = g('out');
    const j = v => JSON.stringify(v, null, 2);
    function show(id){ ['cadastro','verificar','usuarios'].forEach(x=>{ const el=g(x); if(el) el.style.display = (x===id)?'block':'none'; }); }
    (function init(){
      const url = new URL(location.href);
      const email = url.searchParams.get('email'); const code = url.searchParams.get('code');
      if (email) { g('email').value = email; g('email_verify').value = email; }
      if (code) { g('code').value = code; show('verificar'); } else { show('cadastro'); }
    })();
    async function call(method, path, body){
      const res = await fetch(`${BASE}${path}`, { method, headers: { 'Content-Type': 'application/json' }, body: body ? JSON.stringify(body) : undefined });
      const data = await res.json().catch(() => ({})); out.textContent = j({ status: res.status, data }); return data;
    }
    async function signup(){ const d = await call('POST','/auth/signup',{ email:g('email').value, password:g('password').value }); show('verificar'); g('email_verify').value = g('email').value; }
    async function resendVerify(){ const d = await call('POST','/auth/verify-email/resend',{ email:g('email_verify').value }); }
    async function verifyEmail(){ const d = await call('POST','/auth/verify-email',{ email:g('email_verify').value, code:g('code').value }); if(d?.success){ loadUsers(); show('usuarios'); } }
    async function loadUsers(){ const d = await call('GET','/admin/users'); const tbody = document.querySelector('#usersTable tbody'); tbody.innerHTML=''; (d?.data||[]).forEach(u=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${u.email}</td><td>${u.full_name||''}</td><td>${u.status||''}</td><td>
      <button class='btn btn-sm btn-warning' onclick="updateUser('${u.id}')">Editar</button>
      <button class='btn btn-sm btn-danger ms-1' onclick="deleteUser('${u.id}')">Excluir</button>
      <button class='btn btn-sm btn-secondary ms-1' onclick="lockUser('${u.id}')">Lock</button>
      <button class='btn btn-sm btn-success ms-1' onclick="unlockUser('${u.id}')">Unlock</button>
    </td>`; tbody.appendChild(tr); }); }
    async function createUser(){ const d = await call('POST','/admin/users',{ email:g('new_email').value, full_name:g('new_name').value }); loadUsers(); }
    async function updateUser(id){ const name = prompt('Novo nome:'); if(!name) return; const d = await call('PATCH',`/admin/users/${id}`,{ full_name:name }); loadUsers(); }
    async function deleteUser(id){ const d = await call('DELETE',`/admin/users/${id}`); loadUsers(); }
    async function lockUser(id){ const d = await call('POST',`/admin/users/${id}/lock`); loadUsers(); }
    async function unlockUser(id){ const d = await call('POST',`/admin/users/${id}/unlock`); loadUsers(); }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
